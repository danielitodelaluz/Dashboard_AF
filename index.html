<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Cadets Air France</title>

  <!-- Librairies -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- plugin heat-map (matrix) pour Chart.js v4 -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@4.4.0/dist/chartjs-chart-matrix.min.js"></script>


  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:0 1rem 3rem;background:#f5f7fb}
    h1{text-align:center;margin-top:1.2rem}

    /* Filtres */
    .controls{display:flex;flex-wrap:wrap;gap:1rem;justify-content:center;margin:1.5rem 0}

    
    /* Cartes graphiques */
    .chart-wrapper{max-width:950px;margin:0 auto 2rem;background:#fff;border-radius:.75rem;
                   box-shadow:0 4px 10px rgba(0,0,0,.08);padding:1.5rem}

    /* Tableau récapitulatif */
    .summary-wrapper {
      max-width:950px;
      margin:0 auto 2rem;
      background:#fff;
      border-radius:.75rem;
      box-shadow:0 4px 10px rgba(0,0,0,.08);
      padding:1.5rem;
    }
    .summary-table {
      width:100%;
      border-collapse:collapse;
      text-align:center;
    }
    .summary-table th, .summary-table td {
      padding:.5rem;
      border:1px solid #ccc;
    }
    .summary-table th {
      background:#eaeef5;
    }

    /* Graphes ligne / barre → ratio 16:9 */
    canvas.plot{aspect-ratio:16/9;width:100%!important;height:auto!important}

    /* Camemberts → compact */
    canvas.pie{aspect-ratio:1/1;width:100%!important;max-width:450px;height:auto!important;
               margin:0 auto;display:block}

    /* Inputs */
    select,input[type="file"],input[type="date"]
           {padding:.5rem .8rem;border-radius:.4rem;border:1px solid #ccc;font-size:1rem}
    select{min-width:260px;cursor:pointer}
    label{display:flex;align-items:center;gap:.4rem}

    #emptyNotice{color:#b00;text-align:center;margin-top:.5rem;display:none}
  </style>
</head>
<body>
<h1>Tableau de bord – Résultats Cadets Air France</h1>

<div class="controls">
  <input type="file" id="csvFile" accept=".csv" />
  <label>Exercice :
    <select id="exerciseSelect"></select>
  </label>
  <label>Start :
    <input type="date" id="startDate" />
  </label>
  <label>End :
    <input type="date" id="endDate" />
  </label>
</div>
<div class="summary-wrapper">
  <table class="summary-table">
    <thead>
      <tr>
        <th>Classe moyenne globale</th>
        <th>Classe max globale</th>
        <th>Tests semaine</th>
        <th>% de tests ≥ classe 6</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td id="avgGlobalClass">–</td>
        <td id="maxGlobalClass">–</td>
        <td id="testsWeek">–</td>
        <td id="pctTestsGE6">–</td>
      </tr>
    </tbody>
  </table>
</div>
<p id="emptyNotice">Aucun exercice détecté : vérifie les en-têtes du CSV.</p>



<div class="chart-wrapper"><h3>Classe vs temps (exercice sélectionné)</h3><canvas id="classLineChart"  class="plot"></canvas></div>
<div class="chart-wrapper"><h3>Score vs temps (exercice sélectionné)</h3><canvas id="scoreLineChart"  class="plot"></canvas></div>
<div class="chart-wrapper"><h3>Répartition des classes (exercice sélectionné)</h3><canvas id="classPieChart"  class="pie"></canvas></div>
<div class="chart-wrapper"><h3>Classe moyenne globale vs temps</h3><canvas id="globalClassChart" class="plot"></canvas></div>
<div class="chart-wrapper"><h3>Nombre de tests par jour</h3><canvas id="timeDayChart"    class="plot"></canvas></div>
<div class="chart-wrapper"><h3>Répartition des tests par exercice</h3><canvas id="timeExerciseChart" class="pie"></canvas></div>
<div class="chart-wrapper"><h3>Classe moyenne & classe maximale par exercice</h3><canvas id="exStatsChart" class="plot"></canvas></div>
<div class="chart-wrapper"><h3>Essais par exercice</h3><canvas id="exAttemptsChart" class="plot"></canvas></div>
<div class="chart-wrapper"><h3>Forces &amp; faiblesses par grande catégorie</h3><canvas id="catRadarChart" class="pie"></canvas></div>

<script>
/* ---------- constantes ---------- */
const CATEGORY_MAP = {
  "Un mot sur deux":"Verbale","Pair ou impair":"Numérique",
  "Psychomoteur psy0 AF cadet":"Psychomoteur","Formes et couleurs":"Attention",
  "Airways":"Intellectuelle","M2 Back numérique":"Mémorisation",
  "Séries logiques":"Intellectuelle","Billes":"Intellectuelle",
  "Formes glissées - II":"Intellectuelle","Objets 3D":"Spatiale",
  "Empilements":"Spatiale","Cubes 2D/3D - psy0 Air France":"Spatiale",
  "Grilles de calculs":"Numérique","Boîtes à mots":"Verbale",
  "Mots en étoile":"Verbale","Anglais présélection cadets Air France":"Anglais",
  "Angles":"Spatiale","Voitures (séquentiel)":"Spatiale"
};
const MONTHS_FR = {
  "janvier":"January","février":"February","mars":"March","avril":"April","mai":"May",
  "juin":"June","juillet":"July","août":"August","septembre":"September",
  "octobre":"October","novembre":"November","décembre":"December"
};
/* Palette : 8 couleurs */
const palette = ["#4b8bf4","#2ecc71","#f1c40f","#9b59b6","#e67e22","#16a085","#d35400","#7f8c8d"];
const RED = "#e74c3c";

/* ---------- éléments DOM ---------- */
const fileInput      = document.getElementById('csvFile');
const exerciseSelect = document.getElementById('exerciseSelect');
const startDateInput = document.getElementById('startDate');
const endDateInput   = document.getElementById('endDate');
const emptyNotice    = document.getElementById('emptyNotice');

let rawData = [], charts = [];

/* ---------- lecture CSV ---------- */
fileInput.addEventListener('change', e=>{
  const file = e.target.files[0];
  if(!file) return;
  Papa.parse(file,{
    header:true,skipEmptyLines:true,
    complete:r=>{rawData = clean(r.data); populateExercise(); refresh();},
    error:err => alert("Erreur CSV : "+err.message)
  });
});

/* ---------- events ---------- */
exerciseSelect.addEventListener('change', refresh);
[startDateInput,endDateInput].forEach(inp=>inp.addEventListener('change', refresh));

/* ---------- helpers ---------- */
const frToDate = s=>{
  const p=s.split(' ');
  if(p.length>=4){
    const [,day,moFr,year,time='00h00'] = p;
    const mo = MONTHS_FR[moFr.toLowerCase()] || moFr;
    return new Date(`${day} ${mo} ${year} ${time.replace('h',':')}`);
  }
  return new Date(s);
};

function clean(rows){
  return rows.map(r=>{
    const k={}; Object.keys(r).forEach(key=>k[key.toLowerCase().trim()]=r[key]);
    const test =(k['exercice']||k['test']||'').trim();
    const score=parseFloat(String(k['score (%)']||k['score']||'').replace('%',''));
    const cls  =parseInt(k['stanine']||k['classe']||k['class']||NaN);
    const dateRaw=k['at']||k['date']||'';
    const date = dateRaw ? frToDate(dateRaw) : null;
    return {test,score,cls,date,cat:CATEGORY_MAP[test]||'Autre'};
  })
  .filter(d=>d.test && d.date instanceof Date && !isNaN(d.score) && !isNaN(d.cls));
}

function populateExercise(){
  const uniq=[...new Set(rawData.map(d=>d.test))].sort();
  exerciseSelect.innerHTML='';
  if(!uniq.length){
    emptyNotice.style.display='block';
    exerciseSelect.disabled=true;
    return;
  }
  emptyNotice.style.display='none';
  exerciseSelect.disabled=false;
  uniq.forEach(t=>exerciseSelect.insertAdjacentHTML('beforeend',`<option value="${t}">${t}</option>`));
  exerciseSelect.selectedIndex=0;
}

const inRange = d=>{
  const s=startDateInput.value?new Date(startDateInput.value):null;
  const e=endDateInput.value?new Date(endDateInput.value):null;
  return (!s||d.date>=s)&&(!e||d.date<=e);
};
const clearCharts = () => { charts.forEach(c=>c?.destroy()); charts=[] };
const newPie = (ctx,values,labels) => new Chart(ctx,{
  type:'pie',
  data:{labels,datasets:[{data:values,backgroundColor:palette}]},
  options:{responsive:true,maintainAspectRatio:true,aspectRatio:1}
});

/* ---------- refresh ---------- */
function refresh(){

  if(!rawData.length || exerciseSelect.disabled) return;
  const data = rawData.filter(inRange);
  if(!data.length) return;
  clearCharts();
  // Mise à jour du tableau récapitulatif
  const avgGlobal = (data.reduce((sum, d) => sum + d.cls, 0) / data.length).toFixed(2);
  const maxGlobal = Math.max(...data.map(d => d.cls));
  const oneWeekAgo = new Date(); oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
  const testsWeek = data.filter(d => d.date >= oneWeekAgo).length;
  const pctGE6 = ((data.filter(d => d.cls >= 6).length / data.length) * 100).toFixed(1);
  document.getElementById('avgGlobalClass').textContent = avgGlobal;
  document.getElementById('maxGlobalClass').textContent = maxGlobal;
  document.getElementById('testsWeek').textContent = testsWeek;
  document.getElementById('pctTestsGE6').textContent = pctGE6 + '%';

  /* ---------- exercice sélectionné ---------- */
  const sel = exerciseSelect.value;
  const selData = data.filter(d=>d.test===sel).sort((a,b)=>a.date-b.date);

  /* classe vs temps */
  charts.push(new Chart(
    document.getElementById('classLineChart'),{
      type:'line',
      data:{labels:selData.map(d=>d.date.toLocaleDateString('fr-FR')),
            datasets:[{
              label:`Classe – ${sel}`,
              data:selData.map(d=>d.cls),
              borderColor:palette[0],
              backgroundColor:palette[0]+"33",
              tension:.25,pointRadius:4,borderWidth:2
            }]},
      options:{responsive:true,scales:{y:{beginAtZero:true,max:9}}}
  }));

  /* score vs temps */
  charts.push(new Chart(
    document.getElementById('scoreLineChart'),{
      type:'line',
      data:{labels:selData.map(d=>d.date.toLocaleDateString('fr-FR')),
            datasets:[{
              label:`Score (%) – ${sel}`,
              data:selData.map(d=>d.score),
              borderColor:palette[1],
              backgroundColor:palette[1]+"33",
              tension:.25,pointRadius:4,borderWidth:2
            }]},
      options:{responsive:true,scales:{y:{beginAtZero:true,max:100}}}
  }));

  /* ---------- stats par exercice ---------- */
  const byEx={};
  data.forEach(d=>{
    byEx[d.test] ??= {sum:0,cnt:0,max:0};
    byEx[d.test].sum += d.cls;
    byEx[d.test].cnt ++;
    byEx[d.test].max = Math.max(byEx[d.test].max,d.cls);
  });
  const exLabels = Object.keys(byEx).sort();
  const clsAvg   = exLabels.map(k => +(byEx[k].sum / byEx[k].cnt).toFixed(2));
  const clsMax   = exLabels.map(k=> byEx[k].max );
  const attempts = exLabels.map(k=> byEx[k].cnt );

  /* Histogramme : classe moyenne & classe maximale */
  charts.push(new Chart(
    document.getElementById('exStatsChart'),{
      type:'bar',
      data:{
        labels: exLabels,
        datasets:[
          { label:'Classe moyenne',
            data: clsAvg,
            backgroundColor: palette[2] },
          { label:'Classe maximale',
            data: clsMax,
            backgroundColor: RED }
        ]
      },
      options:{
        responsive:true,
        scales:{ y:{ beginAtZero:true } }
      }
  }));

  /* Histogramme : essais par exercice */
  charts.push(new Chart(
    document.getElementById('exAttemptsChart'),{
      type:'bar',
      data:{
        labels: exLabels,
        datasets:[
          { label:'Essais',
            data: attempts,
            backgroundColor: palette[3] }
        ]
      },
      options:{
        responsive:true,
        scales:{ y:{ beginAtZero:true } }
      }
  }));

    /* ---------- radar par catégorie ---------- */
    const byCat = {};
    data.forEach(d => {
      byCat[d.cat] ??= { sum: 0, cnt: 0 };
      byCat[d.cat].sum += d.cls;
      byCat[d.cat].cnt++;
    });
    const catLabels = Object.keys(byCat).sort();
    const catMeans  = catLabels.map(k => (byCat[k].sum / byCat[k].cnt).toFixed(2));

    charts.push(new Chart(
      document.getElementById('catRadarChart'), {
        type: 'radar',
        data: {
          labels: catLabels,
          datasets: [{
            label: 'Classe moyenne',
            data: catMeans,
            backgroundColor: palette[6] + "33",
            borderColor: palette[6],
            borderWidth: 2,
            pointRadius: 4
          }]
        },
        options: {
          responsive: true,
          scales: { r: { beginAtZero: true, min: 0, max: 9 } }
        }
      }
    ));

  /* Camembert classes */
  const clsCount={}; selData.forEach(d=>clsCount[d.cls]=(clsCount[d.cls]||0)+1);
  charts.push(newPie(
    document.getElementById('classPieChart'),
    Object.values(clsCount),
    Object.keys(clsCount)
  ));

  /* Classe moyenne globale vs temps */
  const byDate={};
  data.forEach(d=>{
    const k=d.date.toISOString().split('T')[0];
    byDate[k] ??= {sum:0,cnt:0,date:d.date};
    byDate[k].sum += d.cls;
    byDate[k].cnt ++;
  });
  const dates = Object.values(byDate).sort((a,b)=>a.date-b.date);
  charts.push(new Chart(
    document.getElementById('globalClassChart'),{
      type:'line', 
      data:{labels:dates.map(o=>o.date.toLocaleDateString('fr-FR')),
            datasets:[{
              label:'Classe moyenne globale',
              data:dates.map(o=>(o.sum/o.cnt).toFixed(2)),
              borderColor:palette[4],
              backgroundColor:palette[4]+"33",
              tension:.25,pointRadius:4,borderWidth:2
            }]},
      options:{responsive:true,scales:{y:{beginAtZero:true,max:9}}}
  }));

  /* Tests par jour */
  const byDay={}; data.forEach(d=>{
    const k=d.date.toISOString().split('T')[0];
    byDay[k]=(byDay[k]||0)+1;
  });
  charts.push(new Chart(
    document.getElementById('timeDayChart'),{
      type:'bar',
      data:{labels:Object.keys(byDay).sort(),
            datasets:[{label:'Tests',
                        data:Object.values(byDay),
                        backgroundColor:palette[5]}]},
      options:{responsive:true}
  }));

  /* Répartition tests par exercice */
  charts.push(newPie(
    document.getElementById('timeExerciseChart'),
    attempts,
    exLabels
  ));
  
}
</script>
</body>
</html>
